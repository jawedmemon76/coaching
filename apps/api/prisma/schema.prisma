// Prisma Schema for teacher.ac.pk
// This is the source of truth for the database schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User & Auth Models
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique
  passwordHash  String
  name          String
  avatar        String?
  language      String    @default("en") // 'en' or 'ur'
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  roles         UserRole[]
  sessions      Session[]
  enrollments   Enrollment[]
  progress      Progress[]
  submissions   Submission[]
  createdCourses Course[]    @relation("CourseCreator")
  institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId String?

  @@index([email])
  @@index([institutionId])
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique // STUDENT, TEACHER, ADMIN, etc.
  description String?
  createdAt   DateTime   @default(now())
  
  users       UserRole[]
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  deviceInfo   String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
}

// ============================================================================
// Institution Model (Multi-tenant)
// ============================================================================

model Institution {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  logo         String?
  primaryColor String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users   User[]
  courses Course[]

  @@index([slug])
}

// ============================================================================
// Course & Content Models
// ============================================================================

model Course {
  id            String   @id @default(cuid())
  title         String
  description   String?  @db.Text
  slug          String   @unique
  level         String   // LITERACY, MATRIC, etc.
  board         String?  // FEDERAL, PUNJAB, CAMBRIDGE, etc.
  subject       String
  language      String   @default("en")
  thumbnail     String?
  isPublished   Boolean  @default(false)
  isFree        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  createdBy     User        @relation("CourseCreator", fields: [createdById], references: [id])
  createdById   String
  institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId String?
  modules       Module[]
  enrollments   Enrollment[]
  quizzes       Quiz[]

  @@index([slug])
  @@index([level])
  @@index([subject])
  @@index([createdById])
  @@index([institutionId])
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?  @db.Text
  order       Int      @default(0)
  isLocked    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
  @@index([order])
}

model Lesson {
  id              String   @id @default(cuid())
  moduleId        String
  title           String
  description     String?  @db.Text
  order           Int      @default(0)
  durationMinutes Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  module   Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  contents Content[]
  progress Progress[]

  @@index([moduleId])
  @@index([order])
}

model Content {
  id        String   @id @default(cuid())
  lessonId  String
  type      String   // VIDEO, TEXT, PDF, AUDIO, INTERACTIVE
  title     String
  data      Json     // Flexible storage for content data
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([type])
}

// ============================================================================
// Assessment Models
// ============================================================================

model Question {
  id            String   @id @default(cuid())
  type          String   // MCQ_SINGLE, MCQ_MULTIPLE, TRUE_FALSE, etc.
  text          String   @db.Text
  options       Json?    // Array of options for MCQ
  correctAnswer Json     // String, array, or number depending on type
  explanation   String?  @db.Text
  marks         Int      @default(1)
  difficulty    String   @default("MEDIUM") // EASY, MEDIUM, HARD
  subject       String
  topic         String?
  tags          String[] // Array of tags
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quizQuestions QuizQuestion[]
  paperQuestions PaperQuestion[]

  @@index([subject])
  @@index([topic])
  @@index([difficulty])
  @@index([type])
}

model Quiz {
  id                 String   @id @default(cuid())
  courseId           String?
  title              String
  description        String?  @db.Text
  totalMarks         Int      @default(0)
  durationMinutes    Int?
  shuffleQuestions   Boolean  @default(false)
  shuffleOptions     Boolean  @default(false)
  showCorrectAnswers Boolean  @default(true)
  maxAttempts        Int?
  passingScore       Int?
  isPublished        Boolean  @default(false)
  createdById        String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  course      Course?        @relation(fields: [courseId], references: [id], onDelete: SetNull)
  questions   QuizQuestion[]
  submissions Submission[]

  @@index([courseId])
  @@index([isPublished])
}

model QuizQuestion {
  id         String @id @default(cuid())
  quizId     String
  questionId String
  order      Int    @default(0)

  quiz     Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([quizId, questionId])
  @@index([quizId])
}

model Paper {
  id              String    @id @default(cuid())
  type            String    // PAST_PAPER, GUESS_PAPER, MOCK_EXAM
  title           String
  year            Int?
  session         String?   // e.g., "May/June", "Oct/Nov"
  board           String?
  subject         String
  level           String
  status          String    @default("DRAFT") // DRAFT, UNDER_REVIEW, PUBLISHED, ARCHIVED
  totalMarks      Int       @default(0)
  durationMinutes Int       @default(180)
  createdById     String
  reviewedById    String?
  publishedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  questions   PaperQuestion[]
  submissions Submission[]

  @@index([type])
  @@index([subject])
  @@index([level])
  @@index([status])
}

model PaperQuestion {
  id         String @id @default(cuid())
  paperId    String
  questionId String
  order      Int    @default(0)

  paper    Paper    @relation(fields: [paperId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([paperId, questionId])
  @@index([paperId])
}

// ============================================================================
// Progress & Submission Models
// ============================================================================

model Enrollment {
  id              String    @id @default(cuid())
  userId          String
  courseId        String
  enrolledAt      DateTime  @default(now())
  completedAt     DateTime?
  progressPercent Int       @default(0)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Progress {
  id               String    @id @default(cuid())
  userId           String
  lessonId         String
  completed        Boolean   @default(false)
  completedAt      DateTime?
  timeSpentSeconds Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Submission {
  id          String    @id @default(cuid())
  userId      String
  quizId      String?
  paperId     String?
  answers     Json      // User's answers
  score       Int?
  maxScore    Int
  status      String    @default("SUBMITTED") // SUBMITTED, GRADED, RETURNED
  feedback    String?   @db.Text
  gradedById  String?
  submittedAt DateTime  @default(now())
  gradedAt    DateTime?

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz  Quiz?  @relation(fields: [quizId], references: [id], onDelete: SetNull)
  paper Paper? @relation(fields: [paperId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([quizId])
  @@index([paperId])
  @@index([status])
}

